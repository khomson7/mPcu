//mpcu_epi_send//


BEGIN
	
REPLACE INTO wsc_epi_check(PID,epikey,check_edit)

SELECT * FROM
(select t.PID,t.epikey,t.apicheck FROM
(select t.HOSPCODE,t.PID,(select seq_id FROM ovst_seq where vn = t.vn) as SEQ,t.vaccine_date as DATE_SERV,t.export_vaccine_code as VACCINETYPE 
,t.HOSPCODE as VACCINEPLACE,t.PROVIDER,concat(t.vaccine_date,' ',t.vaccine_time) as D_UPDATE
,MD5(concat('wsc',PID,export_vaccine_code,D_UPDATE)) as apicheck
,MD5(concat('wsc',PID,export_vaccine_code,t.vaccine_date)) as epikey
FROM 
(select (select hospitalcode from opdconfig) as HOSPCODE
,LPAD(pe.person_id, 6, '0') as PID
,we.vaccine_date,we.vaccine_time 
,t.export_vaccine_code,t.doctor_code as PROVIDER
,vn
,concat(we.vaccine_date,' ',we.vaccine_time) as D_UPDATE
from person_epi_vaccine we
LEFT JOIN person_epi pe on pe.person_epi_id = we.person_epi_id
INNER JOIN
(select pev.person_epi_vaccine_id,ev.export_vaccine_code,pev.doctor_code from person_epi_vaccine_list pev
LEFT JOIN epi_vaccine ev on ev.epi_vaccine_id = pev.epi_vaccine_id
WHERE ev.export_vaccine_code is not NULL)t on t.person_epi_vaccine_id = we.person_epi_vaccine_id)t WHERE t.PID is not null)t
WHERE t.epikey not in(select epikey FROM wsc_epi_check) 

UNION

select t.PID,t.epikey,t.apicheck FROM
(select t.HOSPCODE,t.PID,(select seq_id FROM ovst_seq where vn = t.vn) as SEQ,t.service_date as DATE_SERV,t.export_vaccine_code as VACCINETYPE 
,t.HOSPCODE as VACCINEPLACE,t.PROVIDER,concat(t.service_date,' ',t.service_time) as D_UPDATE
,MD5(concat('wsc',PID,export_vaccine_code,concat(t.service_date,' ',t.service_time))) as apicheck
,MD5(concat('wsc',PID,export_vaccine_code,t.service_date)) as epikey
FROM 
(select (select hospitalcode from opdconfig) as HOSPCODE
,LPAD(pw.person_id, 6, '0') as PID
,pws.service_date,pws.service_time,vn,t.export_vaccine_code,t.doctor_code as PROVIDER from person_wbc_service pws
LEFT JOIN person_wbc pw on pw.person_wbc_id = pws.person_wbc_id
INNER JOIN
(select w.person_wbc_service_id,wv.export_vaccine_code,w.doctor_code from person_wbc_vaccine_detail w
LEFT JOIN wbc_vaccine wv on wv.wbc_vaccine_id = w.wbc_vaccine_id
WHERE wv.export_vaccine_code is not NULL)t on t.person_wbc_service_id = pws.person_wbc_service_id)t WHERE t.PID is not null)t
WHERE t.epikey not in(select epikey FROM wsc_epi_check))
t GROUP BY t.epikey
;

END


//mpcu_person_send//

BEGIN
	
INSERT IGNORE INTO wsc_person_encrypt(PID,check_update,wsc_update)
select person_id,'111',last_update FROM person p
WHERE person_id not in(select PID FROM wsc_person_encrypt);


END